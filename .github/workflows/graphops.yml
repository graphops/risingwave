# .github/workflows/graphops.yml
# Trigger this workflow with: gh workflow run graphops.yml --ref graphops/ci-workflows-DO-NOT-MERGE -f ref=graphops/uint256 -f tag=uint256
name: GraphOps - Build Container Image

on:
  workflow_dispatch:
    inputs:
      ref:                 # branch / tag / SHA to build
        description: "Git ref to build"
        required: true
        default: main
      image:               # optional full image name (registry/namespace/repo)
        description: "Image name (leave empty for ghcr.io/<owner>/<repo>)"
        required: false
        default: ""
      tag:                 # optional tag (leave empty for short SHA)
        description: "Image tag"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:              # needed for GHCR push with GITHUB_TOKEN
      contents: read
      packages: write

    steps:
      - name: Check out target ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Derive image name & tag
        id: meta
        run: |
          IMAGE="${{ inputs.image }}"
          if [ -z "$IMAGE" ]; then
            IMAGE="ghcr.io/${{ github.repository_owner }}/$(basename "${GITHUB_REPOSITORY}")"
          fi

          TAG="${{ inputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="$(echo "${GITHUB_SHA}" | cut -c1-8)"
          fi

          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG"     >> "$GITHUB_OUTPUT"

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
          provenance: false     # disable SBOM/provenance to speed things up
